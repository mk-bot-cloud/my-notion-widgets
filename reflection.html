<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: -apple-system, sans-serif; background: #191919; color: #fff; padding: 20px; border-radius: 12px; border: 1px solid #333; max-width: 400px; margin: auto; }
        .title { color: #3b82f6; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 1.1rem; }
        .q-text { font-size: 1rem; margin-bottom: 15px; line-height: 1.5; color: #ddd; min-height: 3em; }
        textarea { width: 100%; background: #252525; border: 1px solid #444; color: #fff; border-radius: 8px; padding: 10px; box-sizing: border-box; resize: vertical; font-size: 14px; margin-bottom: 10px; }
        input[type="number"], input[type="date"] { background: #252525; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 5px; width: 100%; box-sizing: border-box; }
        button { background: #3b82f6; color: white; border: none; border-radius: 6px; padding: 10px 20px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
        button:hover { background: #2563eb; }
        .hidden { display: none; }
        .save-link { background: transparent; border: 2px solid #3b82f6; color: #3b82f6; text-decoration: none; display: block; margin-top: 20px; padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; }
        .save-link:hover { background: rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body>
    <div class="title">Reflection Mentor</div>
    
    <div id="step-start">
        <p style="font-size: 14px; opacity: 0.8;">リフレクションの日付を確認してください</p>
        <input type="date" id="ref-date">
        <button onclick="start()" style="margin-top:15px;">リフレクションを開始</button>
    </div>

    <div id="step-q" class="hidden">
        <div id="q-text" class="q-text"></div>
        <textarea id="a-input" rows="4" placeholder="ここに入力してください..."></textarea>
        <button onclick="next()">次へ進む</button>
    </div>

    <div id="step-score" class="hidden">
        <div class="q-text">今日という日に点数（1〜5点）をつけてください。</div>
        <input type="number" id="score-input" min="1" max="5" value="3">
        <button onclick="finish()" style="margin-top:15px;">結果をまとめる</button>
    </div>

    <div id="step-end" class="hidden">
        <p style="text-align:center;">リフレクションが完了しました！<br>下のボタンを押してNotionに保存してください。</p>
        <a id="save-link" href="#" target="_blank" class="save-link">【Notionに保存する】</a>
    </div>

    <script>
        const qs = [
            { key: "Objective", text: "O（事実）：今日はどのような１日でしたか？客観的な出来事を教えてください。" },
            { key: "Reflective", text: "R（感情）：その時、あなたの心はどう動きましたか？" },
            { key: "Interpretive", text: "I（解釈）：なぜそう感じたのだと思いますか？" },
            { key: "Meaning", text: "M（意味）：この経験は、あなたにとってどんな「ギフト（学び）」になりましたか？" },
            { key: "Decisive", text: "D（決定）：明日、ほんの少しだけ意識することや「小さな挑戦」を教えてください。" }
        ];
        
        let step = 0;
        let results = {};
        let refDate = "";

        // 初期日付を今日に設定
        document.getElementById('ref-date').valueAsDate = new Date();

        function start() {
            refDate = document.getElementById('ref-date').value;
            if(!refDate) return alert("日付を入力してください");
            document.getElementById('step-start').classList.add('hidden');
            document.getElementById('step-q').classList.remove('hidden');
            showQ();
        }

        function showQ() {
            document.getElementById('q-text').textContent = qs[step].text;
            document.getElementById('a-input').value = "";
            document.getElementById('a-input').focus();
        }

        function next() {
            const val = document.getElementById('a-input').value;
            if(!val) return alert("回答を入力してください");
            results[qs[step].key] = val;
            step++;
            if(step < qs.length) {
                showQ();
            } else {
                document.getElementById('step-q').classList.add('hidden');
                document.getElementById('step-score').classList.remove('hidden');
            }
        }

        function finish() {
            const score = document.getElementById('score-input').value;
            const moodMap = ["", "%E2%98%85", "%E2%98%85%E2%98%85", "%E2%98%85%E2%98%85%E2%98%85", "%E2%98%85%E2%98%85%E2%98%85%E2%98%85", "%E2%98%85%E2%98%85%E2%98%85%E2%98%85%E2%98%85"];
            
            // 簡易要約
            const summary = `${results.Objective} / ${results.Decisive}`.substring(0, 100);

            const params = new URLSearchParams({
                date: refDate,
                ...results,
                Summary: summary,
                score: score,
                mood: moodMap[score] || moodMap[3]
            });

            const webhookUrl = "https://hook.eu2.make.com/7q2dfhyhr12b499lavqtp4zcqyiqb837";
            document.getElementById('save-link').href = `${webhookUrl}?${params.toString()}`;
            
            document.getElementById('step-score').classList.add('hidden');
            document.getElementById('step-end').classList.remove('hidden');
        }
    </script>
</body>
</html>
